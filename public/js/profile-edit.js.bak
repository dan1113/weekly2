import { API_BASE, AUTH_HEADERS, apiFetch, setUserId, ensureCsrfToken } from "./config.js";

const fileEl = document.getElementById("file");
const preview = document.getElementById("preview");
const bioEl = document.getElementById("bio");
const saveBtn = document.getElementById("save");

let pendingFile = null;
let previewUrl = null;
const MAX_AVATAR_SIZE = 5 * 1024 * 1024; // 5MB
const CSRF_META = 'meta[name="csrf-token"]';
const MAX_FILE_COUNT = 1;

init();

async function init() {
  await loadProfile();
  fileEl?.addEventListener("change", handleFileChange);
  saveBtn?.addEventListener("click", handleSave);
}

async function getCsrfToken() {
  if (typeof document !== "undefined") {
    const meta = document.querySelector(CSRF_META);
    if (meta?.content) return meta.content;
  }
  try {
    const res = await apiFetch(`/api/csrf`, { credentials: "include" });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data?.csrfToken) return data.csrfToken;
  } catch (err) {
    console.warn("csrf fetch failed", err);
  }
  return "";
}

async function loadProfile() {
  try {
    const sess = await apiFetch("/api/auth/session").then((r) => r.json());
    if (!sess?.loggedIn) {
      location.replace("/login.html");
      return;
    }
    if (sess.userId) setUserId(sess.userId);

    const profileRes = await apiFetch(`/api/users/${encodeURIComponent(sess.userId)}`);
    const profile = await profileRes.json();
    if (profile?.user) {
      const avatarSrc =
        profile.user.avatar_base64 ||
        profile.user.avatar_url ||
        profile.user.avatarKey ||
        "/image/avatar-default.png";
      if (preview) preview.src = avatarSrc;
      if (bioEl) bioEl.value = profile.user.bio || "";
    }
  } catch (err) {
    console.error(err);
    alert("프로필 정보를 불러오지 못했습니다.");
  }
}

function handleFileChange() {
  if (previewUrl) URL.revokeObjectURL(previewUrl);
  const files = Array.from(fileEl?.files || []);
  if (files.length > MAX_FILE_COUNT) {
    alert("프로필 사진은 한 장만 업로드할 수 있습니다.");
    fileEl.value = "";
    pendingFile = null;
    return;
  }
  const file = files[0] || null;
  pendingFile = file;
  if (file && preview) {
    previewUrl = URL.createObjectURL(file);
    preview.src = previewUrl;
  }
}

async function handleSave() {
  if (!saveBtn) return;
  saveBtn.disabled = true;
  const original = saveBtn.textContent;
  saveBtn.textContent = "저장 중...";

  try {
    await ensureCsrfToken();
    // 아바타 업로드 (base64, 단일 파일)
    if (pendingFile) {
      if (!pendingFile.type.startsWith("image/")) {
        throw new Error("이미지 파일만 업로드할 수 있습니다.");
      }
      if (pendingFile.size > MAX_AVATAR_SIZE) {
        throw new Error("프로필 사진은 5MB 이하만 업로드할 수 있습니다.");
      }
      await uploadAvatarBase64(pendingFile);
    }

    if (bioEl) {
      const csrf = await getCsrfToken();
      await apiFetch(`/api/users/me/bio`, {
        method: "POST",
        headers: AUTH_HEADERS({
          "Content-Type": "application/json",
          "X-CSRF-Token": csrf,
        }),
        body: JSON.stringify({ bio: bioEl.value.trim() }),
      }).then(checkOk("소개 저장에 실패했습니다."));
    }

    alert("저장되었습니다.");
    location.href = "/me.html";
  } catch (err) {
    console.error(err);
    alert(err.message || "저장 중 오류가 발생했습니다.");
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = original;
  }
}

function checkOk(message) {
  return async (res) => {
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.error || message);
    }
    return res;
  };
}

async function uploadAvatarBase64(file) {
  const base64 = await fileToBase64(file);
  const csrf = await getCsrfToken();
  const res = await fetch(`${API_BASE}/api/profile/avatar-base64`, {
    method: "POST",
    credentials: "include",
    headers: AUTH_HEADERS({
      "Content-Type": "application/json",
      "X-CSRF-Token": csrf,
    }),
    body: JSON.stringify({
      files: [
        {
          filename: file.name,
          base64,
          mime: file.type,
          order: 0,
        },
      ],
    }),
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data?.error || "아바타 저장에 실패했습니다.");
  return data;
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
