// /public/js/uploader.js  ???꾨윴???꾩슜 ?낅줈??紐⑤뱢
import { apiFetch, AUTH_HEADERS } from "./config.js";

/**
 * ?뚯씪??multipart/form-data濡??낅줈?쒗븯怨?
 * ?쒕쾭媛 ?뚮젮二쇰뒗 怨듦컻 URL(/files/...)??諛섑솚?⑸땲??
 * @param {File} file
 * @returns {Promise<string>} 怨듦컻 URL
 */
export async function uploadFile(file) {
  if (!(file instanceof File)) throw new Error("?뚯씪???놁뒿?덈떎.");

  // 1) CSRF ?좏겙 諛쒓툒 (荑좏궎 ?앹꽦 + ?ㅻ뜑??
  const csrfRes = await apiFetch("/api/csrf", {
    method: "GET",
    credentials: "include",
    headers: AUTH_HEADERS(),
  });
  const { csrfToken } = await csrfRes.json();

  // 2) multipart ?낅줈??  const fd = new FormData();
  fd.append("file", file);

  const res = await apiFetch("/api/profile/avatar", {
    method: "POST",
    credentials: "include",
    headers: AUTH_HEADERS({ "X-CSRF-Token": csrfToken }),
    body: fd,
  });

  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.error || "?낅줈?쒖뿉 ?ㅽ뙣?덉뒿?덈떎.");

  // ?쒕쾭媛 ?쒓났?섎뒗 怨듦컻 寃쎈줈 (/files/avatars/...)
  return j.url;
}

// ?꾩슂?섎㈃ default???대낫?????덉쓬
// export default uploadFile;

